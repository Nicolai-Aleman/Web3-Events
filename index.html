<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web3 Strategic Events Calendar 2026</title>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>

  <style>
    :root{
      --bg:#f4f6f9; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --shadow:0 14px 30px rgba(17,24,39,.08); --shadow2:0 12px 24px rgba(17,24,39,.18);
      --radius:12px; --btn:#111827; --btnText:#fff;
    }

    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:28px 16px;color:var(--text)}
    .wrap{max-width:1120px;margin:0 auto}
    header{display:flex;flex-direction:column;gap:10px;margin-bottom:16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:24px;font-weight:750;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:14px;margin:0;line-height:1.4}

    #calendar{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--border)}
    .error-box{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;color:#111827}
    .error-box strong{display:block;margin-bottom:6px}
    .error-box code{background:#f3f4f6;padding:2px 6px;border-radius:8px}

    /* Modal */
    .modal-overlay{
      position:fixed;inset:0;background:rgba(17,24,39,.55);display:none;align-items:center;justify-content:center;
      padding:16px;z-index:9999
    }
    .modal{
      width:min(860px,100%);background:var(--card);border-radius:14px;box-shadow:var(--shadow2);
      border:1px solid var(--border);overflow:hidden
    }
    .modal-header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;padding:16px 16px 10px 16px;
      border-bottom:1px solid var(--border);background:#fbfbfd
    }
    .modal-title{margin:0;font-size:18px;font-weight:750;line-height:1.3}
    .modal-meta{margin-top:6px;color:var(--muted);font-size:13px;display:flex;flex-wrap:wrap;gap:10px}
    .pill{
      display:inline-flex;align-items:center;padding:5px 10px;border:1px solid var(--border);border-radius:999px;
      background:#fff;font-size:12px;color:#374151
    }
    .modal-close{
      border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;
      font-weight:750;color:#111827;font-size:13px
    }
    .modal-body{padding:14px 16px 16px 16px;display:grid;grid-template-columns:1fr;gap:12px}
    .section{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .section h3{margin:0 0 6px 0;font-size:12px;color:#374151;letter-spacing:.2px;text-transform:uppercase}
    .section p{margin:0;color:#111827;font-size:14px;line-height:1.45;white-space:pre-wrap}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    .event-actions{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-start;
      padding-top:4px;
    }
    .btn{
      appearance:none;border:1px solid var(--border);background:var(--btn);color:var(--btnText);
      border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer;font-size:13px;
      width: 100%;
    }
    .hint{color:var(--muted);font-size:12.5px;line-height:1.35;margin:0}

    @media (max-width:760px){
      .two-col{grid-template-columns:1fr}
      body{padding:20px 12px}
    }

    /* FullCalendar polish */
    .fc .fc-toolbar-title{font-size:18px;font-weight:750}
    .fc .fc-button{border-radius:10px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="topbar">
        <h1>Web3 Strategic Events Calendar 2026</h1>
      </div>
      <p class="subtitle">Click an event to see details and add it to Apple Calendar.</p>
    </header>

    <div id="calendar"></div>
  </div>

  <!-- Event Details Modal -->
  <div id="eventModalOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="eventModalTitle">
      <div class="modal-header">
        <div>
          <h2 id="eventModalTitle" class="modal-title">Event</h2>
          <div class="modal-meta">
            <span id="eventModalDate" class="pill">Date</span>
            <span id="eventModalLocation" class="pill" style="display:none;">Location</span>
          </div>
        </div>
        <button id="eventModalClose" class="modal-close" type="button">Close</button>
      </div>

      <div class="modal-body">
        <div class="section">
          <div class="event-actions">
            <button id="addToAppleBtn" class="btn" type="button">Add to Apple Calendar</button>
          </div>
          <p class="hint" style="margin-top:10px;">
            Best experience on Safari (iPhone/Mac). This adds only this event, not the entire calendar.
          </p>
        </div>

        <div class="two-col">
          <div class="section">
            <h3>Primary focus</h3>
            <p id="eventModalFocus">—</p>
          </div>
          <div class="section">
            <h3>Ideal audience</h3>
            <p id="eventModalAudience">—</p>
          </div>
        </div>

        <div class="section">
          <h3>Strategic relevance</h3>
          <p id="eventModalRelevance">—</p>
        </div>

        <div class="section">
          <h3>Notes</h3>
          <p id="eventModalNotes">—</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const ICS_FILENAME = "Calendario_Eventos_Web3_2026.ics";

    // Enriched details per event title (must match SUMMARY in the ICS exactly).
    const EVENT_DETAILS = {
      "CfC St. Moritz": {
        location: "St. Moritz, Switzerland (Villa Beaulieu)",
        focus: "Curated, investor-grade digital assets and market-structure conversations.",
        audience: "Institutional investors, private banks, family offices, regulators, top-tier founders.",
        relevance: "High signal environment for discreet partnerships, positioning, and strategic alignment.",
        notes: "Industry Days 2026: Jan 13–17, 2026. Venue: Villa Beaulieu, St. Moritz. Use for CEO-level networking and confidential dealflow."
      },
      "Consensus Hong Kong": {
        location: "Hong Kong (Hong Kong Convention & Exhibition Centre)",
        focus: "Institutional scale digital assets, market infrastructure, regulation, and global capital.",
        audience: "Builders, VCs, institutions, exchanges, policymakers, compliance and market-structure teams.",
        relevance: "Strong for Asia expansion, distribution partnerships, and regulatory narratives.",
        notes: "Dates: Feb 10–12, 2026. Venue: Hong Kong Convention & Exhibition Centre (HKCEC). Prioritize meetings around capital, custody, and cross-border rails."
      },
      "ETHDenver": {
        location: "Denver, Colorado, USA",
        focus: "Builder ecosystem, engineering, protocols, dev tooling, and hands-on experimentation.",
        audience: "Developers, protocol teams, product engineers, infra builders, community operators.",
        relevance: "Best for product traction, integrations, recruiting technical talent, and ecosystem presence.",
        notes: "Dates: Feb 17–21, 2026. Go with a concrete roadmap: wallets, rails, smart contracts, infra, SDKs. Plan side-events for partner demos."
      }
    };

    function pad2(n){ return String(n).padStart(2, "0"); }
    function icalDateToISODate(t){ return `${t.year}-${pad2(t.month)}-${pad2(t.day)}`; }

    function formatDisplayDateFromEvent(event){
      // Uses Date objects for reliable display in the user’s locale
      const allDay = event.allDay;
      const start = event.start;
      const end = event.end;

      const dateOpts = { year:"numeric", month:"short", day:"2-digit" };
      const dateTimeOpts = { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" };

      if (!start) return "—";

      if (allDay){
        const sText = new Intl.DateTimeFormat("en-US", dateOpts).format(start);
        if (!end) return sText;

        // FullCalendar end is exclusive for all-day events; show inclusive range
        const eMinusOne = new Date(end.getTime());
        eMinusOne.setDate(eMinusOne.getDate() - 1);

        const eText = new Intl.DateTimeFormat("en-US", dateOpts).format(eMinusOne);
        if (sText === eText) return sText;
        return `${sText} to ${eText}`;
      } else {
        const sText = new Intl.DateTimeFormat("en-US", dateTimeOpts).format(start);
        if (!end) return sText;
        const eText = new Intl.DateTimeFormat("en-US", dateTimeOpts).format(end);
        return `${sText} to ${eText}`;
      }
    }

    function openOverlay(id, focusId){
      const overlay = document.getElementById(id);
      overlay.style.display = "flex";
      overlay.setAttribute("aria-hidden", "false");
      if (focusId){
        const el = document.getElementById(focusId);
        if (el) setTimeout(() => el.focus(), 0);
      }
    }
    function closeOverlay(id){
      const overlay = document.getElementById(id);
      overlay.style.display = "none";
      overlay.setAttribute("aria-hidden", "true");
    }

    // --- Apple Calendar: Create a single-event ICS and open it ---
    function escapeIcsText(s){
      // RFC5545 escaping: backslash, comma, semicolon, newline
      return String(s || "")
        .replace(/\\/g, "\\\\")
        .replace(/\r\n/g, "\n")
        .replace(/\r/g, "")
        .replace(/\n/g, "\\n")
        .replace(/,/g, "\\,")
        .replace(/;/g, "\\;");
    }

    function toIcsUtc(dt){
      const y = dt.getUTCFullYear();
      const m = pad2(dt.getUTCMonth()+1);
      const d = pad2(dt.getUTCDate());
      const hh = pad2(dt.getUTCHours());
      const mm = pad2(dt.getUTCMinutes());
      const ss = pad2(dt.getUTCSeconds());
      return `${y}${m}${d}T${hh}${mm}${ss}Z`;
    }

    function ymdToCompact(ymd){
      // "YYYY-MM-DD" -> "YYYYMMDD" without replaceAll
      return String(ymd || "").split("-").join("");
    }

    function buildSingleEventIcs({ title, start, end, allDay, description, location }){
      const uid = `web3-${Math.random().toString(16).slice(2)}@nicolai-aleman.github.io`;
      const now = toIcsUtc(new Date());

      let dtStartLine = "";
      let dtEndLine = "";

      if (allDay){
        // start/end are expected as YYYY-MM-DD strings here
        dtStartLine = `DTSTART;VALUE=DATE:${ymdToCompact(start)}`;

        if (end){
          // end for all-day is exclusive (FullCalendar convention)
          dtEndLine = `DTEND;VALUE=DATE:${ymdToCompact(end)}`;
        } else {
          // If no end, make it a 1-day event by setting DTEND = start + 1 day
          const s = new Date(start + "T00:00:00");
          s.setDate(s.getDate() + 1);
          const y = s.getFullYear();
          const m = pad2(s.getMonth()+1);
          const d = pad2(s.getDate());
          dtEndLine = `DTEND;VALUE=DATE:${y}${m}${d}`;
        }
      } else {
        // start/end are ISO strings
        const s = new Date(start);
        const e = end ? new Date(end) : new Date(s.getTime() + 60*60*1000);
        dtStartLine = `DTSTART:${toIcsUtc(s)}`;
        dtEndLine = `DTEND:${toIcsUtc(e)}`;
      }

      const locLine = location ? `LOCATION:${escapeIcsText(location)}` : "";
      const descLine = `DESCRIPTION:${escapeIcsText(description || "")}`;

      const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Web3 Events//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${now}
SUMMARY:${escapeIcsText(title)}
${dtStartLine}
${dtEndLine}
${locLine}
${descLine}
END:VEVENT
END:VCALENDAR`;

      // Ensure CRLF line endings
      return ics.replace(/\n/g, "\r\n");
    }

    function openAppleCalendarForEvent(icsText, suggestedName){
      const filename = (suggestedName || "event").replace(/[^\w\-]+/g, "_") + ".ics";
      const blob = new Blob([icsText], { type: "text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      // Safari/iOS: navigating to the blob URL typically triggers Calendar import
      // Also create a fallback download link (helps in some desktop edge cases)
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);

      // Try navigation first (import flow), then fallback click
      window.location.href = url;
      setTimeout(() => {
        try { a.click(); } catch(_) {}
        document.body.removeChild(a);
      }, 200);

      setTimeout(() => URL.revokeObjectURL(url), 60000);
    }

    let CURRENT_EVENT_PAYLOAD = null;

    document.addEventListener("DOMContentLoaded", async function(){
      // Modal handlers
      document.getElementById("eventModalClose").addEventListener("click", () => closeOverlay("eventModalOverlay"));
      document.getElementById("eventModalOverlay").addEventListener("click", function(e){
        if (e.target === this) closeOverlay("eventModalOverlay");
      });
      document.addEventListener("keydown", function(e){
        if (e.key === "Escape") closeOverlay("eventModalOverlay");
      });

      document.getElementById("addToAppleBtn").addEventListener("click", function(){
        if (!CURRENT_EVENT_PAYLOAD) return;
        const ics = buildSingleEventIcs(CURRENT_EVENT_PAYLOAD);
        openAppleCalendarForEvent(ics, CURRENT_EVENT_PAYLOAD.title);
      });

      // Load full ICS to render calendar (robust error handling)
      const calendarEl = document.getElementById("calendar");
      let events = [];

      try {
        const response = await fetch(ICS_FILENAME, { cache: "no-store" });
        if (!response.ok){
          throw new Error(`Could not load ICS file. HTTP ${response.status}. Check that "${ICS_FILENAME}" is in the same folder as index.html.`);
        }

        const text = await response.text();
        const jcalData = ICAL.parse(text);
        const comp = new ICAL.Component(jcalData);
        const vevents = comp.getAllSubcomponents("vevent");

        events = vevents.map(v => {
          const e = new ICAL.Event(v);
          const isAllDay = e.startDate && e.startDate.isDate === true;

          let startVal, endVal;
          if (isAllDay){
            startVal = icalDateToISODate(e.startDate); // YYYY-MM-DD
            endVal = e.endDate ? icalDateToISODate(e.endDate) : null; // exclusive end
          } else {
            startVal = e.startDate ? e.startDate.toJSDate().toISOString() : null;
            endVal = e.endDate ? e.endDate.toJSDate().toISOString() : null;
          }

          return {
            title: e.summary || "Event",
            start: startVal,
            end: endVal,
            allDay: isAllDay,
            extendedProps: { description: e.description || "" }
          };
        });

      } catch (err){
        calendarEl.innerHTML =
          `<div class="error-box">
             <strong>Calendar could not be loaded</strong>
             <div style="margin-bottom:8px;">Make sure the ICS file exists and is reachable:</div>
             <div><code>${ICS_FILENAME}</code></div>
             <div style="margin-top:10px;color:#6b7280;font-size:12.5px;">Technical detail: ${escapeHtml(String(err && err.message ? err.message : err))}</div>
           </div>`;
        return;
      }

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        initialDate: "2026-01-01",
        locale: "en",
        height: "auto",
        headerToolbar: { left: "prev,next today", center: "title", right: "dayGridMonth,listMonth" },
        events,
        eventClick: function(info){
          info.jsEvent.preventDefault();

          const title = info.event.title;
          const details = EVENT_DETAILS[title] || {};

          const displayDate = formatDisplayDateFromEvent(info.event);

          // Fill modal text
          document.getElementById("eventModalTitle").textContent = title;
          document.getElementById("eventModalDate").textContent = displayDate;

          const locEl = document.getElementById("eventModalLocation");
          const locationText = details.location || "";
          if (locationText){
            locEl.style.display = "inline-flex";
            locEl.textContent = locationText;
          } else {
            locEl.style.display = "none";
          }

          document.getElementById("eventModalFocus").textContent = details.focus || "—";
          document.getElementById("eventModalAudience").textContent = details.audience || "—";
          document.getElementById("eventModalRelevance").textContent = details.relevance || "—";
          document.getElementById("eventModalNotes").textContent =
            details.notes || info.event.extendedProps.description || "—";

          // Prepare payload for single-event ICS
          if (info.event.allDay){
            CURRENT_EVENT_PAYLOAD = {
              title,
              start: info.event.startStr,                 // YYYY-MM-DD
              end: info.event.endStr || null,             // YYYY-MM-DD (exclusive) or null
              allDay: true,
              description: (details.notes || info.event.extendedProps.description || ""),
              location: locationText
            };
          } else {
            CURRENT_EVENT_PAYLOAD = {
              title,
              start: info.event.start ? info.event.start.toISOString() : null,
              end: info.event.end ? info.event.end.toISOString() : null,
              allDay: false,
              description: (details.notes || info.event.extendedProps.description || ""),
              location: locationText
            };
          }

          openOverlay("eventModalOverlay", "addToAppleBtn");
        }
      });

      calendar.render();
    });

    function escapeHtml(str){
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
